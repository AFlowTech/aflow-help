# ERP系统对接aiflow流程中心设计方案

## 1. 概述

### 1.1 对接目标

将ERP系统（如Odoo ERP）的业务流程接入到aiflow流程中心，实现以下目标：

1. **业务流程集中管理**：将公司Odoo ERP或其他任意系统的业务流程接入到aiflow，所有审批与任务执行集中到aiflow的任务中心进行审批
2. **业务流程分析与优化**：通过流程中心实现业务流程的全链路显现化，支持AI分析业务流程数据

### 1.2 aiflow流程中心定位

1. **人机协同**：业务流程全链路显现化
2. **全过程管理**：只关注审批或执行的过程数据，不管理业务数据与核心业务逻辑，只控制过程分支
3. **任务中心**：统一的任务处理入口

### 1.3 执行步骤（分阶段实施）

#### 阶段一：工作周日报流程接入
- 接入工作周日报流程
- AI分析周日报结果
- 流程中心管理团队工作进度

#### 阶段二：任务中心统一简易集成方案
- 将销售流程接入到任务中心
- 审批详情页与发起页仍然跳转到业务系统
- 处理完成后将任务状态回传到任务中心，更新待办列表
- 统一处理入口到待办列表

#### 阶段三：全面使用流程中心的表单与流程引擎方案
- 表单与过程数据彻底打通
- 流程中心提供完整的表单与流程引擎能力

---

## 2. 对接方案概述

### 2.1 基础数据同步方案

基础数据同步是系统对接的基础，主要包括部门数据和用户数据的同步。**无论采用哪种方案，最终都需要将钉钉、ERP、aiflow的用户编码（UserId）和部门编码（deptId）进行绑定。**

#### 2.1.1 方案对比

| 特性 | 方案一：ERP主动推送 | 方案二：aiflow主动同步钉钉（推荐） |
|------|-------------------|--------------------------------|
| **同步方向** | ERP → aiflow | 钉钉 → aiflow（定时任务） |
| **aiflow开发** | 需要开发推送接收接口 | 使用现有钉钉同步机制 |
| **ERP开发** | 需要开发推送逻辑 | 无需开发推送接口 |
| **绑定时机** | ERP推送 → 钉钉登录时绑定 | 钉钉同步时绑定 → SSO登录时绑定ERP |
| **实施复杂度** | 中等 | 低（复用现有机制） |
| **推荐度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

#### 2.1.2 方案一：ERP主动推送方案

**方案说明：** ERP系统主动将部门和用户数据推送到aiflow系统。

**核心要点：**
- **签名算法**：采用HMAC-SHA256签名算法确保接口安全
- **批量同步**：支持批量同步部门和用户数据
- **数据映射**：自动建立部门映射和用户映射关系
- **同步策略**：支持增量同步和全量同步

**用户绑定流程：**
1. ERP推送用户数据到aiflow
2. 用户在钉钉小程序中登录aiflow
3. aiflow通过钉钉token获取用户手机号
4. 通过手机号匹配，绑定钉钉用户编码和ERP用户编码

**主要任务：**

**aiflow方任务：**
- 开发部门同步接口（`POST /aflow/api/sys/sync/department`）
- 开发用户同步接口（`POST /aflow/api/sys/sync/user`）
- 实现签名验证机制
- 实现数据映射和存储逻辑
- 实现钉钉登录时的用户绑定逻辑（通过手机号匹配）

**Odoo方任务：**
- 集成 aflow Python SDK（使用统一签名算法，无需自行实现）
- 开发部门数据推送逻辑
- 开发用户数据推送逻辑
- 实现数据变更监听和自动同步

**技术要点和任务清单：**
- **接口定义和任务清单**：参考 [技术详细设计文档 - 基础数据同步方案](integration-technical-design.md#2-基础数据同步方案)（包含接口定义和双方任务清单）
- **签名算法**：参考 [技术原理文档 - 签名算法](technical-details.md#签名算法)（包含签名生成步骤和验证流程）
- **时序图**：参考 [技术原理文档 - 部门数据同步时序图](technical-details.md#部门数据同步时序图)（展示完整的同步流程）
- **数据库设计**：参考 [技术原理文档 - 数据库设计](technical-details.md#数据库设计)（包含部门映射表和用户映射表设计）

#### 2.1.3 方案二：aiflow主动同步钉钉方案（推荐）

**方案说明：** aiflow通过定时任务主动从钉钉同步部门和用户数据，ERP用户信息在SSO登录时进行绑定。

**核心要点：**
- **复用现有机制**：使用aiflow现有的钉钉同步机制（`DingDingUserSyncHandle`、`DingDingDeptSyncHandler`）
- **定时同步**：通过定时任务全量同步钉钉的部门和用户数据
- **用户绑定**：钉钉同步时绑定钉钉关系，SSO登录时绑定ERP关系
- **无需ERP推送**：ERP无需开发推送接口，减少对接工作量

**用户绑定流程：**
1. aiflow定时任务同步钉钉部门和用户数据（绑定钉钉用户编码）
2. 用户通过SSO登录aiflow（OAuth2流程）
3. aiflow获取ERP用户信息（通过OAuth2 userinfo接口）
4. 通过手机号或邮箱匹配，绑定ERP用户编码和部门编码

**主要任务：**

**aiflow方任务：**
- 配置钉钉同步定时任务（复用现有`LinkSyncJob`）
- 实现SSO登录时的用户绑定逻辑（通过手机号/邮箱匹配ERP用户）
- 实现部门编码绑定逻辑（SSO登录时绑定ERP部门编码）
- 无需开发ERP推送接收接口

**Odoo方任务：**
- 无需开发推送接口
- 确保OAuth2 userinfo接口返回手机号和邮箱信息
- 确保OAuth2 userinfo接口返回部门ID信息

**技术要点和任务清单：** 参考 [技术详细设计文档 - 基础数据同步方案（方案二）](integration-technical-design.md#2-基础数据同步方案) 和 [双方任务清单 - 阶段一](integration-technical-design.md#阶段一基础数据同步)

**技术要点：**
- **钉钉同步机制**：参考现有代码 `DingDingUserSyncHandle`、`DingDingDeptSyncHandler`
- **定时任务**：参考 [技术原理文档 - 钉钉同步定时任务](technical-details.md#方案二aiflow主动同步钉钉方案)（复用`LinkSyncJob`）
- **用户绑定逻辑**：参考 [技术原理文档 - SSO登录用户绑定](technical-details.md#sso登录用户绑定逻辑)
- **数据库设计**：参考 [技术原理文档 - 数据库设计](technical-details.md#数据库设计)（使用现有的`link_user_mapping`和`link_dept_mapping`表）

#### 2.1.4 方案选择建议

**推荐使用方案二**，原因：
1. **复用现有机制**：aiflow已有完整的钉钉同步实现，无需重复开发
2. **减少对接工作量**：ERP无需开发推送接口和签名算法
3. **统一数据源**：以钉钉为统一的数据源，避免多数据源冲突
4. **绑定时机清晰**：钉钉同步时绑定钉钉关系，SSO登录时绑定ERP关系，逻辑清晰

**方案一适用于：**
- ERP系统已有完善的数据推送机制
- 需要实时同步数据（非定时同步）
- ERP系统不支持OAuth2 SSO对接

### 2.2 SSO单点登录对接方案（OAuth 2.0）

实现aiflow与Odoo ERP系统的单点登录（SSO），当用户在aiflow系统中遇到401未授权错误时，自动跳转到Odoo进行认证，认证成功后返回aiflow系统。

#### 2.2.1 核心要点

- **OAuth2流程**：采用标准的OAuth 2.0授权码（Authorization Code）流程
- **单点登录**：用户只需在Odoo登录一次，即可访问aiflow系统
- **Token刷新**：支持Token自动刷新机制
- **安全防护**：完善的CSRF防护机制（state参数）

#### 2.2.2 主要任务

**aiflow方任务：**
- 实现OAuth2配置管理
- 开发OAuth2客户端（调用Odoo接口）
- 改造认证拦截器（401跳转逻辑）
- 开发OAuth2回调处理器（`GET /aflow/api/oauth2/callback`）
- 实现Token刷新机制

**Odoo方任务：**
- 开发OAuth2授权端点（`GET /odoo/api/oauth2/authorize`）
- 开发OAuth2令牌端点（`POST /odoo/api/oauth2/token`）
- 开发用户信息端点（`GET /odoo/api/oauth2/userinfo`）
- 实现客户端注册和管理功能

**详细任务清单请参考：** [任务计划文档 - SSO单点登录对接方案](./integration-task-checklist.md#二sso单点登录对接方案oauth-20)（包含aiflow方和Odoo方的详细任务清单）

#### 2.2.3 技术要点

- **OAuth2原理图**：参考 [技术原理文档 - OAuth2原理图](technical-details.md#oauth2原理图)（展示OAuth2授权码流程的完整原理）
- **完整时序图**：参考 [技术原理文档 - OAuth2接口调用时序图](technical-details.md#oauth2接口调用时序图)（27个步骤的详细时序）
- **Token刷新时序图**：参考 [技术原理文档 - Token刷新时序图](technical-details.md#token刷新时序图)（Token过期时的刷新流程）
- **Odoo接口标准**：参考 [技术原理文档 - Odoo需要提供的接口标准](technical-details.md#odoo需要提供的接口标准)（授权端点、令牌端点、用户信息端点）
- **aiflow系统改动**：参考 [技术原理文档 - aiflow系统改动方案](technical-details.md#aiflow系统改动方案)（配置管理、拦截器改造、回调处理器、代码结构）
- **接口定义和任务清单**：参考 [技术详细设计文档 - SSO单点登录对接方案](integration-technical-design.md#3-sso单点登录对接方案) 和 [双方任务清单 - 阶段二](integration-technical-design.md#阶段二sso单点登录对接)

### 2.3 任务中心统一简易集成方案

该方案适用于快速对接场景，业务流程仍然在外部系统（如Odoo）中执行，aiflow只负责：
- 展示待办任务列表
- 提供统一的处理入口
- 跳转到外部系统进行实际处理
- 接收处理结果，更新待办列表

#### 2.3.1 核心要点

- **最小改造**：最小化系统改造，快速对接
- **第三方引擎**：流程定义支持第三方引擎类型（THIRD_PARTY）
- **任务同步**：待办任务自动同步到aiflow
- **状态回调**：任务处理完成后自动回调更新状态

#### 2.3.2 主要任务

**aiflow方任务：**
- 扩展流程定义表结构（添加引擎类型、URL配置等字段）
- 开发流程发起接口（`POST /aflow/api/order/start_third_party_flow`）
- 开发待办任务同步接口（`POST /aflow/api/order/sync/todo`）
- 开发任务完成回调接口（`POST /aflow/api/order/task/complete`）
- 实现前端跳转逻辑（待办列表跳转到Odoo详情页）

**Odoo方任务：**
- 开发流程发起页（H5和PC端）
- 开发流程详情页（H5和PC端）
- 实现待办任务数据收集和推送逻辑
- 实现任务处理完成后的回调逻辑

**技术要点和任务清单：**
- **接口定义和任务清单**：参考 [技术详细设计文档 - 任务中心简易集成方案](integration-technical-design.md#4-任务中心简易集成方案) 和 [双方任务清单 - 阶段三](integration-technical-design.md#阶段三任务中心简易集成)
- **流程定义改造**：参考 [技术原理文档 - 流程定义改造](technical-details.md#流程定义改造)（流程引擎类型扩展、第三方引擎配置）
- **流程发起时序图**：参考 [技术原理文档 - 第三方流程发起时序图](technical-details.md#第三方流程发起时序图)（从流程发起到待办同步的完整流程）
- **任务完成回调时序图**：参考 [技术原理文档 - 任务处理完成回调时序图](technical-details.md#任务处理完成回调时序图)（从任务处理到待办列表更新的完整流程）
- **数据库设计**：参考 [技术原理文档 - 流程定义扩展表](technical-details.md#流程定义扩展表)（流程定义表扩展字段和第三方任务表）

### 2.4 全面使用流程中心的表单与流程引擎方案

该方案是深度集成方案，外部系统（如Odoo）完全使用aiflow的表单和流程引擎，实现表单与过程数据的彻底打通。

#### 2.4.1 核心要点

- **流程管理**：流程定义和表单定义完全由aiflow管理
- **表单同步**：支持表单自动同步（Webhook或定时同步）
- **数据推送**：ServiceTask自动推送流程数据到外部系统
- **日志回传**：审批日志自动回传到aiflow

#### 2.4.2 主要任务

**aiflow方任务：**
- 开发流程定义管理接口（创建、修改、发布）
  - `POST /aflow/api/flow/create`
  - `PUT /aflow/api/flow/update`
  - `POST /aflow/api/flow/publish`
- 开发表单同步接口（`POST /aflow/api/form/sync`）
- 实现ServiceTask HTTP调用（推送数据到Odoo）
- 开发审批日志接口（`POST /aflow/api/order/approval/log`）

**Odoo方任务：**
- 实现流程定义管理对接（调用aiflow接口）
- 实现表单变更监听和同步
- 开发流程数据接收接口（`POST /odoo/api/workflow/receive`）
- 开发审批日志回传逻辑
- 实现表单Schema转换工具（Odoo格式转aiflow格式）

**技术要点和任务清单：**
- **接口定义和任务清单**：参考 [技术详细设计文档 - 全面流程引擎集成方案](integration-technical-design.md#5-全面流程引擎集成方案) 和 [双方任务清单 - 阶段四](integration-technical-design.md#阶段四全面流程引擎集成)
- **流程定义管理**：参考 [技术原理文档 - 流程定义管理接口](technical-details.md#流程定义管理接口)（创建、修改、发布流程定义的业务逻辑）
- **表单同步方案**：参考 [技术原理文档 - 表单同步方案](technical-details.md#表单同步方案)（Webhook机制和定时同步两种方式）
- **ServiceTask数据推送时序图**：参考 [技术原理文档 - ServiceTask数据推送时序图](technical-details.md#servicetask数据推送时序图)（包含重试机制和错误处理）
- **表单Schema转换**：Odoo需要实现表单Schema转换工具，将Odoo表单格式转换为aiflow表单格式（参考 [技术详细设计文档 - 表单同步接口](integration-technical-design.md#52-表单同步接口) 了解aiflow表单Schema格式要求）

---

## 3. 方案对比

| 特性 | 任务中心简易集成 | 全面流程引擎集成 |
|------|----------------|----------------|
| **实施复杂度** | 低 | 高 |
| **开发周期** | 4周 | 6周 |
| **系统改造** | 最小化 | 深度改造 |
| **流程控制** | 外部系统 | aiflow流程引擎 |
| **表单管理** | 外部系统 | aiflow表单引擎 |
| **数据同步** | 待办任务同步 | 完整数据同步 |
| **适用场景** | 快速对接、最小改造 | 深度集成、统一管理 |

---

## 4. 实施建议

### 4.1 分阶段实施策略

建议采用分阶段实施策略，逐步深入：

1. **第一阶段**：完成基础数据同步和SSO对接，建立基础对接能力
2. **第二阶段**：选择1-2个简单流程，使用任务中心简易集成方案快速验证
3. **第三阶段**：根据业务需求，逐步将更多流程接入
4. **第四阶段**：对于核心流程，考虑使用全面流程引擎集成方案

### 4.2 方案选择建议

- **任务中心简易集成方案**适用于：
  - 需要快速对接的场景
  - 业务流程复杂，改造成本高的系统
  - 只需要统一待办列表的场景

- **全面流程引擎集成方案**适用于：
  - 需要统一流程管理的场景
  - 需要流程分析和优化的场景
  - 业务流程相对标准化的场景

---

## 5. 风险评估与应对

### 5.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 签名算法实现不一致 | 高 | 先进行签名算法联调 |
| 数据格式不匹配 | 中 | 提前确认数据格式 |
| OAuth2实现复杂度 | 中 | 参考标准实现，充分测试 |
| 性能问题 | 中 | 做好性能测试和优化 |

### 5.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 数据格式不匹配 | 中 | 提供数据转换工具，支持自定义映射 |
| 流程定义变更 | 中 | 支持版本管理，平滑升级 |
| 系统故障 | 高 | 实现降级方案，保证核心功能可用 |

---

## 6. 相关文档

- **[技术详细设计文档](integration-technical-design.md)** - 整合的接口定义和双方任务清单（**推荐双方开发人员优先查阅**）
- **[技术原理文档](technical-details.md)** - 详细的技术实现、时序图、数据库设计等

---

## 7. 总结

本文档概述了ERP系统对接aiflow流程中心的完整方案，包括：

1. **基础数据同步**：部门、用户数据的同步方案
2. **SSO对接**：基于OAuth 2.0的单点登录方案
3. **任务中心简易集成**：快速对接方案，最小化改造
4. **全面流程引擎集成**：深度集成方案，完全使用aiflow的表单和流程引擎

方案采用分阶段实施策略，可以根据实际需求选择合适的集成深度。所有接口都采用统一的签名验证机制，确保安全性。

详细的技术实现、接口定义和任务清单请参考相关子文档。
